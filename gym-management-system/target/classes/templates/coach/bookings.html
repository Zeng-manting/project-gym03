<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„çº¦ç®¡ç† - å¥èº«æ•™ç»ƒç³»ç»Ÿ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ä½¿ç”¨Bootstrapå›¾æ ‡æ›¿ä»£Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.min.css">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
        }
        .sidebar h4 {
            border-bottom: 1px solid #34495e;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .sidebar a {
            color: #ecf0f1;
            display: block;
            padding: 0.5rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background-color: #34495e;
            color: #3498db;
        }
        .content {
            padding: 2rem;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .search-bar {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .table-responsive {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .btn-action {
            margin: 0 2px;
            font-size: 0.875rem;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-active {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-cancelled {
            background-color: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- ä¾§è¾¹æ  -->
            <div class="col-md-2 sidebar">
                <h4>æ•™ç»ƒä¸­å¿ƒ</h4>
                <a href="/coach/index">é¦–é¡µ</a>
                <a href="/coach/courses">æˆ‘çš„è¯¾ç¨‹</a>
                <a href="/coach/bookings" class="active">é¢„çº¦ç®¡ç†</a>
                <a href="/coach/profile">ä¸ªäººèµ„æ–™</a>
                <a href="/logout">é€€å‡ºç™»å½•</a>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="col-md-10 content">
                <div class="mb-4">
                    <h1 class="h3">é¢„çº¦ç®¡ç†</h1>
                    <p class="text-muted">æŸ¥çœ‹å’Œç®¡ç†æ‚¨è¯¾ç¨‹çš„æ‰€æœ‰é¢„çº¦è®°å½•</p>
                </div>

                <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
                <div class="search-bar mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="searchKeyword">æœç´¢å…³é”®è¯</label>
                                <input type="text" class="form-control" id="searchKeyword" placeholder="è¾“å…¥ä¼šå‘˜æ‰‹æœºå·æˆ–è¯¾ç¨‹åç§°">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="searchDate">é¢„çº¦æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="searchDate">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="searchStatus">é¢„çº¦çŠ¶æ€</label>
                                <select class="form-control" id="searchStatus">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="BOOKED">å·²é¢„çº¦</option>
                                    <option value="CANCELLED">å·²å–æ¶ˆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="searchBookings()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                æœç´¢
                            </button>
                        </div>
                    </div>
                </div>

                <!-- é¢„çº¦è®°å½•è¡¨æ ¼ -->
                <div class="table-responsive mb-4">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>è¯¾ç¨‹åç§°</th>
                                <th>ä¼šå‘˜å§“å</th>
                                <th>ä¼šå‘˜æ‰‹æœºå·</th>
                                <th>é¢„çº¦æ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- è¿™é‡Œå°†é€šè¿‡ThymeleafåŠ¨æ€å¡«å……æ•°æ® -->
                            <tr th:each="booking, iterStat : ${bookings}">
                                <td th:text="${iterStat.index + 1}"></td>
                                <td th:text="${booking.courseName}"></td>
                                    <td th:text="${booking.memberName != null ? booking.memberName : ''}"></td>
                                    <td th:text="${booking.memberPhone}"></td>
                                    <td th:text="${#temporals.format(booking.bookingTime, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                    <span th:class="${booking.status == 'BOOKED' ? 'status-badge status-active' : 'status-badge status-cancelled'}" 
                                          th:text="${booking.status == 'BOOKED' ? 'å·²é¢„çº¦' : 'å·²å–æ¶ˆ'}"></span>
                                </td>
                                <td>
                                    <button th:if="${booking.status == 'BOOKED'}" 
                                            class="btn btn-danger btn-sm btn-action" 
                                            th:onclick="|cancelBooking('${booking.id}')|" 
                                            title="å–æ¶ˆé¢„çº¦">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        å–æ¶ˆ
                                    </button>
                                    <button class="btn btn-info btn-sm btn-action" 
                                            th:onclick="|viewMember('${booking.memberId}')|" 
                                            title="æŸ¥çœ‹ä¼šå‘˜è¯¦æƒ…">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                        æŸ¥çœ‹ä¼šå‘˜
                                    </button>
                                </td>
                            </tr>
                            <!-- æ— æ•°æ®æ—¶æ˜¾ç¤º -->
                            <tr th:if="${bookings.size() == 0}">
                                <td colspan="6" class="text-center">æš‚æ— é¢„çº¦è®°å½•</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µæ§åˆ¶ -->
                <div class="row justify-content-between align-items-center">
                    <div class="col-md-4">
                        <p class="text-muted">å…± <span th:text="${total}"></span> æ¡è®°å½•</p>
                    </div>
                    <div class="col-md-8">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end">
                                <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                                    <a class="page-link" th:href="@{/coach/bookings(page=${currentPage - 1})}" tabindex="-1">ä¸Šä¸€é¡µ</a>
                                </li>
                                <li th:each="i : ${#numbers.sequence(1, totalPages)}" class="page-item" th:classappend="${currentPage == i ? 'active' : ''}">
                                    <a class="page-link" th:href="@{/coach/bookings(page=${i})}" th:text="${i}"></a>
                                </li>
                                <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                                    <a class="page-link" th:href="@{/coach/bookings(page=${currentPage + 1})}">ä¸‹ä¸€é¡µ</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ä¼šå‘˜è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberModalLabel">ä¼šå‘˜è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card gradient-bg text-center p-4">
                                <div id="memberName" class="h3 mb-2">--</div>
                                <div id="memberPhone" class="text-white-80 mb-4">--</div>
                                <div class="rounded-circle mx-auto d-flex justify-content-center align-items-center" style="width: 120px; height: 120px; background-color: #e9ecef; color: #6c757d; font-size: 3rem;">ğŸ‘¤</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>æ€§åˆ«ï¼š</strong><span id="memberGender">--</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>ç”Ÿæ—¥ï¼š</strong><span id="memberBirthday">--</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>é‚®ç®±ï¼š</strong><span id="memberEmail">--</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>è”ç³»åœ°å€ï¼š</strong><span id="memberAddress">--</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>ç´§æ€¥è”ç³»äººï¼š</strong><span id="memberEmergencyContact">--</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>ç´§æ€¥è”ç³»ç”µè¯ï¼š</strong><span id="memberEmergencyPhone">--</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <strong>å¥åº·çŠ¶å†µï¼š</strong><span id="memberHealthCondition">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å–æ¶ˆé¢„çº¦æ¨¡æ€æ¡† -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel">ç¡®è®¤å–æ¶ˆé¢„çº¦</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>ç¡®å®šè¦å–æ¶ˆè¯¥é¢„çº¦è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">ç¡®è®¤å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰è¦å–æ¶ˆçš„é¢„çº¦ID
        let currentCancelBookingId = null;
        
        // æœç´¢é¢„çº¦è®°å½•
        function searchBookings() {
            const keyword = document.getElementById('searchKeyword').value;
            const date = document.getElementById('searchDate').value;
            const status = document.getElementById('searchStatus').value;
            
            // æ„é€ URLå‚æ•°
            let url = '/coach/bookings?';
            if (keyword) url += `keyword=${encodeURIComponent(keyword)}&`;
            if (date) url += `date=${date}&`;
            if (status) url += `status=${status}&`;
            
            // è·³è½¬åˆ°æœç´¢ç»“æœé¡µé¢
            window.location.href = url;
        }
        
        // æ‰“å¼€å–æ¶ˆé¢„çº¦ç¡®è®¤æ¨¡æ€æ¡†
        function cancelBooking(bookingId) {
            currentCancelBookingId = bookingId;
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
            cancelModal.show();
        }
        
        // ç¡®è®¤å–æ¶ˆé¢„çº¦
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            if (currentCancelBookingId) {
                // å‘é€å–æ¶ˆé¢„çº¦è¯·æ±‚
                fetch(`/coach/bookings/cancel/${currentCancelBookingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°è¡¨æ ¼
                        location.reload();
                    } else {
                        alert('å–æ¶ˆé¢„çº¦å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        });
        
        // æŸ¥çœ‹ä¼šå‘˜è¯¦æƒ…
        function viewMember(memberId) {
            // è¿™é‡Œåº”è¯¥é€šè¿‡AJAXè¯·æ±‚è·å–ä¼šå‘˜è¯¦æƒ…
            // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
            
            // æ¨¡æ‹Ÿæ•°æ®å¡«å……
            document.getElementById('memberName').textContent = 'å¼ ä¸‰';
            document.getElementById('memberPhone').textContent = '13800138000';
            document.getElementById('memberGender').textContent = 'ç”·';
            document.getElementById('memberBirthday').textContent = '1990-01-01';
            document.getElementById('memberEmail').textContent = 'zhangsan@example.com';
            document.getElementById('memberAddress').textContent = 'åŒ—äº¬å¸‚æœé˜³åŒº';
            document.getElementById('memberEmergencyContact').textContent = 'æå››';
            document.getElementById('memberEmergencyPhone').textContent = '13900139000';
            document.getElementById('memberHealthCondition').textContent = 'å¥åº·ï¼Œæ— ç‰¹æ®Šæƒ…å†µ';
            
            memberModal.show();
        }
    </script>
</body>
</html>