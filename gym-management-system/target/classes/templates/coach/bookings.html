<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预约管理 - 健身教练系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .sidebar .nav-link {
            color: #adb5bd;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover {
            color: white;
            background-color: #495057;
        }
        .sidebar .nav-link.active {
            color: white;
            background-color: #0d6efd;
        }
        .content-wrapper {
            padding: 20px;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .search-bar {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .table-responsive {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .btn-action {
            margin: 0 2px;
            font-size: 0.875rem;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-active {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-cancelled {
            background-color: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏导航 -->
            <nav class="col-md-2 sidebar">
                <div class="sidebar-sticky">
                    <div class="text-center p-4">
                        <h4>健身教练系统</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/coach">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/coach/courses">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                                我的课程
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/coach/bookings">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                预约管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                退出登录
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main role="main" class="col-md-10 content-wrapper">
                <div class="mb-4">
                    <h1 class="h3">预约管理</h1>
                    <p class="text-muted">查看和管理您课程的所有预约记录</p>
                </div>

                <!-- 搜索和筛选区域 -->
                <div class="search-bar mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="searchKeyword">搜索关键词</label>
                                <input type="text" class="form-control" id="searchKeyword" placeholder="输入会员手机号或课程名称">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="searchDate">预约日期</label>
                                <input type="date" class="form-control" id="searchDate">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="searchStatus">预约状态</label>
                                <select class="form-control" id="searchStatus">
                                    <option value="">全部状态</option>
                                    <option value="BOOKED">已预约</option>
                                    <option value="CANCELLED">已取消</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="searchBookings()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                搜索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 预约记录表格 -->
                <div class="table-responsive mb-4">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>课程名称</th>
                                <th>会员手机号</th>
                                <th>预约时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 这里将通过Thymeleaf动态填充数据 -->
                            <tr th:each="booking, iterStat : ${bookings}">
                                <td th:text="${iterStat.index + 1}"></td>
                                <td th:text="${booking.courseName}"></td>
                                <td th:text="${booking.memberPhone}"></td>
                                <td th:text="${#temporals.format(booking.bookingTime, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                    <span th:class="${booking.status == 'BOOKED' ? 'status-badge status-active' : 'status-badge status-cancelled'}" 
                                          th:text="${booking.status == 'BOOKED' ? '已预约' : '已取消'}"></span>
                                </td>
                                <td>
                                    <button th:if="${booking.status == 'BOOKED'}" 
                                            class="btn btn-danger btn-sm btn-action" 
                                            th:onclick="|cancelBooking('${booking.id}')|" 
                                            title="取消预约">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        取消
                                    </button>
                                    <button class="btn btn-info btn-sm btn-action" 
                                            th:onclick="|viewMember('${booking.memberId}')|" 
                                            title="查看会员详情">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                        查看会员
                                    </button>
                                </td>
                            </tr>
                            <!-- 无数据时显示 -->
                            <tr th:if="${bookings.size() == 0}">
                                <td colspan="6" class="text-center">暂无预约记录</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页控制 -->
                <div class="row justify-content-between align-items-center">
                    <div class="col-md-4">
                        <p class="text-muted">共 <span th:text="${total}"></span> 条记录</p>
                    </div>
                    <div class="col-md-8">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end">
                                <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                                    <a class="page-link" th:href="@{/coach/bookings(page=${currentPage - 1})}" tabindex="-1">上一页</a>
                                </li>
                                <li th:each="i : ${#numbers.sequence(1, totalPages)}" class="page-item" th:classappend="${currentPage == i ? 'active' : ''}">
                                    <a class="page-link" th:href="@{/coach/bookings(page=${i})}" th:text="${i}"></a>
                                </li>
                                <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                                    <a class="page-link" th:href="@{/coach/bookings(page=${currentPage + 1})}">下一页</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 会员详情模态框 -->
    <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberModalLabel">会员详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card gradient-bg text-center p-4">
                                <div id="memberName" class="h3 mb-2">--</div>
                                <div id="memberPhone" class="text-white-80 mb-4">--</div>
                                <img src="https://picsum.photos/200/200" class="rounded-circle img-thumbnail mx-auto" style="width: 120px; height: 120px;" alt="会员头像">
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>性别：</strong><span id="memberGender">--</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>生日：</strong><span id="memberBirthday">--</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>邮箱：</strong><span id="memberEmail">--</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>联系地址：</strong><span id="memberAddress">--</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>紧急联系人：</strong><span id="memberEmergencyContact">--</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>紧急联系电话：</strong><span id="memberEmergencyPhone">--</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <strong>健康状况：</strong><span id="memberHealthCondition">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认取消预约模态框 -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel">确认取消预约</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要取消该预约记录吗？此操作无法撤销。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">确认取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量存储当前要取消的预约ID
        let currentCancelBookingId = null;
        
        // 搜索预约记录
        function searchBookings() {
            const keyword = document.getElementById('searchKeyword').value;
            const date = document.getElementById('searchDate').value;
            const status = document.getElementById('searchStatus').value;
            
            // 构造URL参数
            let url = '/coach/bookings?';
            if (keyword) url += `keyword=${encodeURIComponent(keyword)}&`;
            if (date) url += `date=${date}&`;
            if (status) url += `status=${status}&`;
            
            // 跳转到搜索结果页面
            window.location.href = url;
        }
        
        // 打开取消预约确认模态框
        function cancelBooking(bookingId) {
            currentCancelBookingId = bookingId;
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
            cancelModal.show();
        }
        
        // 确认取消预约
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            if (currentCancelBookingId) {
                // 发送取消预约请求
                fetch(`/coach/bookings/cancel/${currentCancelBookingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // 刷新页面或更新表格
                        location.reload();
                    } else {
                        alert('取消预约失败，请重试');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请重试');
                });
            }
        });
        
        // 查看会员详情
        function viewMember(memberId) {
            // 这里应该通过AJAX请求获取会员详情
            // 为了演示，我们使用模拟数据
            const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
            
            // 模拟数据填充
            document.getElementById('memberName').textContent = '张三';
            document.getElementById('memberPhone').textContent = '13800138000';
            document.getElementById('memberGender').textContent = '男';
            document.getElementById('memberBirthday').textContent = '1990-01-01';
            document.getElementById('memberEmail').textContent = 'zhangsan@example.com';
            document.getElementById('memberAddress').textContent = '北京市朝阳区';
            document.getElementById('memberEmergencyContact').textContent = '李四';
            document.getElementById('memberEmergencyPhone').textContent = '13900139000';
            document.getElementById('memberHealthCondition').textContent = '健康，无特殊情况';
            
            memberModal.show();
        }
    </script>
</body>
</html>