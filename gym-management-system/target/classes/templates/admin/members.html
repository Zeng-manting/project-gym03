<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会员管理 - 健身房管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
        }
        .sidebar h4 {
            border-bottom: 1px solid #34495e;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .sidebar a {
            color: #ecf0f1;
            display: block;
            padding: 0.5rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background-color: #34495e;
            color: #3498db;
        }
        .content {
            padding: 2rem;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .search-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .table-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .table thead {
            background-color: #f8f9fa;
        }
        .table th,
        .table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }
        .btn {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            margin: 0 0.25rem;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-expired {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar">
                <h4>管理系统</h4>
                <a th:href="@{/admin}">首页</a>
                <a th:href="@{/admin/members}" class="active">会员管理</a>
                <a th:href="@{/admin/coaches}">教练管理</a>
                <a th:href="@{/admin/courses}">课程管理</a>
                <a th:href="@{/admin/cards}">会员卡设置</a>
                <a th:href="@{/logout}">退出登录</a>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-10 content">
                <h2 class="mb-4">会员管理</h2>

                <!-- 搜索区域 -->
                <div class="search-container">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="searchName" class="form-label">会员姓名</label>
                            <input type="text" class="form-control" id="searchName" placeholder="请输入姓名">
                        </div>
                        <div class="col-md-3">
                            <label for="searchPhone" class="form-label">手机号</label>
                            <input type="text" class="form-control" id="searchPhone" placeholder="请输入手机号">
                        </div>
                        <div class="col-md-3">
                            <label for="searchStatus" class="form-label">状态</label>
                            <select class="form-select" id="searchStatus">
                                <option value="">全部</option>
                                <option value="active">活跃</option>
                                <option value="inactive">未激活</option>
                                <option value="expired">已过期</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchCardType" class="form-label">卡类型</label>
                            <select class="form-select" id="searchCardType">
                                <option value="">全部</option>
                                <option value="month">月卡</option>
                                <option value="quarter">季卡</option>
                                <option value="year">年卡</option>
                                <option value="unlimited">无限卡</option>
                            </select>
                        </div>
                        <div class="col-md-12 text-center">
                            <button class="btn btn-primary" onclick="searchMembers()">
                                <i class="fa fa-search"></i> 搜索
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetSearch()">
                                <i class="fa fa-refresh"></i> 重置
                            </button>
                            <button class="btn btn-success" onclick="addMember()">
                                <i class="fa fa-plus"></i> 新增会员
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 会员表格 -->
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>姓名</th>
                                <th>手机号</th>
                                <th>性别</th>
                                <th>年龄</th>
                                <th>会员卡类型</th>
                                <th>有效期至</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <!-- 表格数据通过Thymeleaf动态生成 -->
                            <!-- 正确的字段访问方式，直接访问User对象的字段 -->
                            <tr th:if="${members == null or members.empty}">
                                <td colspan="9" class="text-center">暂无会员数据</td>
                            </tr>
                            <tr th:each="member : ${members}">
                                    <td th:text="${member.id}"></td>
                                    <td th:text="${member.name != null ? member.name : '未设置'}"></td>
                                    <td th:text="${member.phone}"></td>
                                    <td>
                                        <span th:if="${member.gender != null and (member.gender == '男' or member.gender == '1')}">男</span>
                                        <span th:elseif="${member.gender != null and (member.gender == '女' or member.gender == '0')}">女</span>
                                        <!-- <span th:else>未知</span> -->
                                    </td>
                                    <td th:text="${member.age != null ? member.age : '-'}"></td>
                                    <td th:text="${member.cardType != null ? member.cardType : '未设置'}"></td>
                                    <td th:text="${member.expireDate != null ? #dates.format(member.expireDate, 'yyyy-MM-dd') : '未设置'}"></td>
                                    <td>
                                        <span th:switch="${member.status}">
                                            <span th:case="'active'" class="status-badge status-active">活跃</span>
                                            <span th:case="'disabled'" class="status-badge status-inactive">禁用</span>
                                            <span th:case="*" class="status-badge status-active">活跃</span>
                                        </span>
                                    </td>
                                <td>
                                    <!-- 使用数据属性替代复杂的onclick表达式 -->
                                    <button class="btn btn-info member-action" data-action="view" th:data-id="${member.id}"><i class="fa fa-eye"></i></button>
                                    <button class="btn btn-warning member-action" data-action="edit" th:data-id="${member.id}"><i class="fa fa-edit"></i></button>
                                    <button class="btn btn-danger member-action" data-action="delete" th:data-id="${member.id}"><i class="fa fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">显示 1-5 条，共 236 条</div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item"><a class="page-link" href="#">...</a></li>
                                <li class="page-item"><a class="page-link" href="#">48</a></li>
                                <li class="page-item"><a class="page-link" href="#">下一页</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑会员模态框 -->
    <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberModalLabel">会员信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="memberForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="memberName" class="form-label">姓名</label>
                                <input type="text" class="form-control" id="memberName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="memberPhone" class="form-label">手机号</label>
                                <input type="tel" class="form-control" id="memberPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="memberGender" class="form-label">性别</label>
                                <select class="form-select" id="memberGender" required>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="memberAge" class="form-label">年龄</label>
                                <input type="number" class="form-control" id="memberAge" min="1" max="120" required>
                            </div>
                            <div class="col-md-6">
                                <label for="memberCardType" class="form-label">会员卡类型</label>
                                <select class="form-select" id="memberCardType" required>
                                    <option value="月卡">月卡</option>
                                    <option value="季卡">季卡</option>
                                    <option value="年卡">年卡</option>
                                    <option value="无限卡">无限卡</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="memberExpireDate" class="form-label">有效期至</label>
                                <input type="date" class="form-control" id="memberExpireDate">
                            </div>
                            <div class="col-md-12">
                                <label for="memberNote" class="form-label">备注</label>
                                <textarea class="form-control" id="memberNote" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="saveMember()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">确定要删除这个会员吗？此操作不可撤销。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        // 初始化模态框
        const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        let currentDeleteMemberId = null;
        
        // 为所有会员操作按钮添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const actionButtons = document.querySelectorAll('.member-action');
            actionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'view') {
                        viewMember(id);
                    } else if (action === 'edit') {
                        editMember(id);
                    } else if (action === 'delete') {
                        deleteMember(id);
                    }
                });
            });
            
            // 为确认删除按钮添加事件监听器
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                confirmDeleteMember();
            });
        });

        // 分页相关变量
        var currentPage = 1;
        var pageSize = 5;
        var totalItems = 0;
        var totalPages = 0;
        var allMembers = [];
        
        // 初始化会员列表和分页
        function initMemberList() {
            // 获取URL参数中的搜索条件
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('name')) document.getElementById('searchName').value = urlParams.get('name');
            if (urlParams.get('phone')) document.getElementById('searchPhone').value = urlParams.get('phone');
            if (urlParams.get('status')) document.getElementById('searchStatus').value = urlParams.get('status');
            if (urlParams.get('cardType')) document.getElementById('searchCardType').value = urlParams.get('cardType');
            
            // 获取所有会员数据
            $.ajax({
                url: '/admin/members' + buildQueryParams(),
                type: 'GET',
                dataType: 'html',
                success: function(html) {
                    // 从返回的HTML中提取会员表格数据
                    var memberTableBody = $(html).find('#memberTableBody').html();
                    $('#memberTableBody').html(memberTableBody);
                    
                    // 重新绑定事件
                    bindMemberActions();
                    
                    // 从table中提取会员数据用于分页
                    extractMembersFromTable();
                    
                    // 初始化分页
                    setupPagination();
                }
            });
        }
        
        // 构建查询参数
        function buildQueryParams() {
            const name = document.getElementById('searchName').value;
            const phone = document.getElementById('searchPhone').value;
            const status = document.getElementById('searchStatus').value;
            const cardType = document.getElementById('searchCardType').value;
            
            let queryParams = '';
            if (name) queryParams += `&name=${encodeURIComponent(name)}`;
            if (phone) queryParams += `&phone=${encodeURIComponent(phone)}`;
            if (status) queryParams += `&status=${encodeURIComponent(status)}`;
            if (cardType) queryParams += `&cardType=${encodeURIComponent(cardType)}`;
            
            return queryParams ? `?${queryParams.substring(1)}` : '';
        }
        
        // 从表格中提取会员数据
        function extractMembersFromTable() {
            allMembers = [];
            $('#memberTableBody tr').each(function() {
                var id = $(this).find('td:first').text(); // 获取ID
                if (id && id !== '暂无会员数据') {
                    allMembers.push({ id: id, row: $(this).clone() });
                }
            });
            totalItems = allMembers.length;
            totalPages = Math.ceil(totalItems / pageSize);
        }
        
        // 设置分页控件
        function setupPagination() {
            var paginationContainer = document.querySelector('.pagination');
            if (!paginationContainer) return;
            
            // 更新分页信息
            var pageInfo = document.querySelector('.text-muted');
            if (pageInfo) {
                var startItem = totalItems > 0 ? (currentPage - 1) * pageSize + 1 : 0;
                var endItem = Math.min(currentPage * pageSize, totalItems);
                pageInfo.textContent = '显示 ' + startItem + '-' + endItem + ' 条，共 ' + totalItems + ' 条';
            }
            
            // 清空现有分页按钮
            paginationContainer.innerHTML = '';
            
            // 添加上一页按钮
            var prevButton = document.createElement('li');
            prevButton.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
            prevButton.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
            prevButton.onclick = function() {
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
                return false;
            };
            paginationContainer.appendChild(prevButton);
            
            // 添加页码按钮（最多显示10个页码）
            var startPage = Math.max(1, currentPage - 4);
            var endPage = Math.min(totalPages, startPage + 9);
            
            if (endPage - startPage < 9) {
                startPage = Math.max(1, endPage - 9);
            }
            
            for (var i = startPage; i <= endPage; i++) {
                var pageButton = document.createElement('li');
                pageButton.className = 'page-item' + (i === currentPage ? ' active' : '');
                pageButton.innerHTML = '<a class="page-link" href="#">' + i + '</a>';
                pageButton.onclick = (function(pageNum) {
                    return function() {
                        goToPage(pageNum);
                        return false;
                    };
                })(i);
                paginationContainer.appendChild(pageButton);
            }
            
            // 添加下一页按钮
            var nextButton = document.createElement('li');
            nextButton.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
            nextButton.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
            nextButton.onclick = function() {
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
                return false;
            };
            paginationContainer.appendChild(nextButton);
            
            // 更新表格显示
            updateTableDisplay();
        }
        
        // 跳转到指定页
        function goToPage(pageNum) {
            currentPage = pageNum;
            setupPagination();
        }
        
        // 更新表格显示内容
        function updateTableDisplay() {
            var tbody = $('#memberTableBody');
            tbody.empty();
            
            var startIndex = (currentPage - 1) * pageSize;
            var endIndex = Math.min(startIndex + pageSize, totalItems);
            
            for (var i = startIndex; i < endIndex; i++) {
                tbody.append(allMembers[i].row);
            }
            
            // 如果没有数据，显示空行
            if (totalItems === 0) {
                tbody.append('<tr><td colspan="9" class="text-center">暂无会员数据</td></tr>');
            }
            
            // 重新绑定事件
            bindMemberActions();
        }
        
        // 绑定会员操作按钮事件
        function bindMemberActions() {
            // 为所有会员操作按钮添加事件监听器
            const actionButtons = document.querySelectorAll('.member-action');
            actionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'view') {
                        viewMember(id);
                    } else if (action === 'edit') {
                        editMember(id);
                    } else if (action === 'delete') {
                        deleteMember(id);
                    }
                });
            });
        }
        
        // 搜索会员
        function searchMembers() {
            currentPage = 1; // 重置为第一页
            
            // 使用AJAX获取会员数据
            $.ajax({
                url: '/admin/members' + buildQueryParams(),
                type: 'GET',
                dataType: 'html',
                success: function(html) {
                    // 从返回的HTML中提取会员表格数据
                    var memberTableBody = $(html).find('#memberTableBody').html();
                    $('#memberTableBody').html(memberTableBody);
                    
                    // 从table中提取会员数据用于分页
                    extractMembersFromTable();
                    
                    // 设置分页
                    setupPagination();
                }
            });
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchCardType').value = '';
            searchMembers();
        }

        // 添加会员
        function addMember() {
            // 重置表单
            document.getElementById('memberForm').reset();
            document.getElementById('memberModalLabel').textContent = '新增会员';
            
            // 显示模态框
            memberModal.show();
        }

        // 查看会员详情 - 使用AJAX获取会员详情
        function viewMember(id) {
            $.ajax({
                url: '/admin/members/' + id,
                type: 'GET',
                dataType: 'json',
                success: function(member) {
                    // 填充模态框数据
                    // 注意：此处需要确保HTML中有对应的查看详情模态框和元素ID
                    alert(`查看会员：${member.name}\n手机号：${member.phone}\n状态：${member.status === 1 ? '活跃' : '禁用'}`);
                },
                error: function() {
                    alert('获取会员详情失败');
                }
            });
        }

        // 编辑会员 - 使用AJAX获取会员详情
        function editMember(id) {
            document.getElementById('memberModalLabel').textContent = '编辑会员';
            
            $.ajax({
                url: '/admin/members/' + id,
                type: 'GET',
                dataType: 'json',
                success: function(member) {
                    // 填充表单数据
                    document.getElementById('memberName').value = member.name || '';
                    document.getElementById('memberPhone').value = member.phone || '';
                    document.getElementById('memberGender').value = member.gender === '1' ? '男' : '女';
                    if (document.getElementById('memberAge')) {
                        document.getElementById('memberAge').value = member.age || '';
                    }
                    document.getElementById('memberCardType').value = member.cardType || '';
                    document.getElementById('memberExpireDate').value = member.expireDate || '';
                    
                    // 如果表单中有会员ID隐藏字段，设置它
                    if (document.getElementById('memberId')) {
                        document.getElementById('memberId').value = member.id;
                    }
                    
                    // 显示模态框
                    memberModal.show();
                },
                error: function() {
                    alert('获取会员详情失败');
                }
            });
        }

        // 删除会员 - 显示确认模态框
        function deleteMember(id) {
            // 保存当前要删除的会员ID
            currentDeleteMemberId = id;
            // 更新确认消息，显示具体的会员ID
            document.getElementById('deleteConfirmMessage').textContent = `确定要删除ID为${id}的会员吗？此操作不可撤销。`;
            // 显示确认模态框
            deleteConfirmModal.show();
        }
        
        // 确认删除会员 - 使用AJAX删除
    function confirmDeleteMember() {
        if (currentDeleteMemberId) {
            $.ajax({
                url: '/admin/members/' + currentDeleteMemberId,
                type: 'DELETE',
                success: function() {
                    // 关闭模态框
                    deleteConfirmModal.hide();
                    // 重新初始化会员列表，保持在当前页码
                    initMemberList();
                },
                error: function() {
                    // 关闭模态框
                    deleteConfirmModal.hide();
                    alert('会员删除失败');
                }
            });
            // 重置当前删除ID
            currentDeleteMemberId = null;
        }
    }

        // 保存会员 - 使用AJAX保存到后端
        function saveMember() {
            // 验证表单
            if (!document.getElementById('memberForm').checkValidity()) {
                document.getElementById('memberForm').reportValidity();
                return;
            }

            // 获取表单数据
            const id = document.getElementById('memberId') ? document.getElementById('memberId').value : null;
            const name = document.getElementById('memberName').value;
            const phone = document.getElementById('memberPhone').value;
            const gender = document.getElementById('memberGender').value === '男' ? '1' : '0';
            const age = document.getElementById('memberAge') ? document.getElementById('memberAge').value : null;
            const cardType = document.getElementById('memberCardType').value;
            const expireDate = document.getElementById('memberExpireDate').value;
            const note = document.getElementById('memberNote') ? document.getElementById('memberNote').value : '';

            // 构建请求数据
            const memberData = {
                name: name,
                phone: phone,
                gender: gender,
                cardType: cardType,
                expireDate: expireDate,
                note: note
            };
            
            if (age) memberData.age = age;

            // AJAX请求保存数据
            $.ajax({
                url: id ? '/admin/members/' + id : '/admin/members',
                type: id ? 'PUT' : 'POST',
                contentType: 'application/json',
                data: JSON.stringify(memberData),
                success: function() {
                    // 隐藏模态框
                    memberModal.hide();
                    // 清空表单
                    document.getElementById('memberForm').reset();
                    // 重新初始化会员列表，保持在当前页码
                    initMemberList();
                },
                error: function() {
                    alert(id ? '会员信息更新失败' : '会员添加失败');
                }
            });
        }
    </script>
    
    <!-- 初始化脚本 -->
    <script>
        // 页面加载完成后初始化会员列表
        $(document).ready(function() {
            initMemberList();
        });
    </script>
</body>
</html>